{% extends "base.html" %}
{% load crispy_forms_tags static %}
{% block title %}
  {% if invoice %}Edit Invoice{% else %}Create Invoice{% endif %}
{% endblock %}

{% block extra_css %}
<link
  href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css"
  rel="stylesheet" />
{% endblock %}

{% block content %}
<div class="container">
  <h2 class="mb-4">
    {% if invoice %}Edit Invoice{% else %}Create Invoice{% endif %}
  </h2>

  <!-- Navigation Buttons -->
  <div class="mb-4 text-center">
    <a href="{% url 'invoice_unpaid' %}"  class="btn btn-outline-danger me-2">Unpaid</a>
    <a href="{% url 'invoice_paid' %}"    class="btn btn-outline-danger me-2">Paid</a>
    <a href="{% url 'invoice_overdue' %}" class="btn btn-outline-danger me-2">Overdue</a>
    <a href="{% url 'invoice_create' %}" class="btn btn-danger">New Invoice</a>
  </div>

  <!-- Events List (replacing pickup/dropoff) -->
  {% if events %}
    <div class="mb-4">
      <h4>Scheduled Events</h4>
      <ul>
        {% for event in events %}
          <li>
            <strong>{{ event.get_event_type_display }}:</strong>
            {{ event.address }} — {{ event.date|date:"Y-m-d" }}
          </li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}

  {# 1️⃣ GET form to load work orders for a client #}
  <form method="get" class="mb-4">
    {{ form.client|as_crispy_field }}
    <button type="submit" class="btn btn-outline-primary">Load Jobs</button>
  </form>

  {# 2️⃣ POST form to actually create/update the invoice #}
  <form method="post" id="invoice-form">
    {% csrf_token %}
    {# preserve the chosen client on POST #}
    <input type="hidden" name="client" value="{{ form.initial.client }}">

    {{ form.work_order|as_crispy_field }}
    {{ form.amount|as_crispy_field }}
    {{ form.due_date|as_crispy_field }}
    {{ form.notes|as_crispy_field }}

    <button type="submit" class="btn btn-success">
      {% if invoice %}Update Invoice{% else %}Create Invoice{% endif %}
    </button>
  </form>

  <a href="{% url 'invoice_list' %}" class="btn btn-secondary mt-3">
    Back to Invoice Overview
  </a>
  <a href="{% url 'home' %}" class="btn btn-secondary mt-3">
    Back to Dashboard
  </a>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function() {
  // Only initialize Select2 on the client field
  $('#id_client').select2({
    placeholder: 'Search for a client…',
    allowClear: true,
    minimumInputLength: 1,
    ajax: {
      url: "{% url 'ajax_get_clients' %}",
      dataType: 'json',
      delay: 250,
      data: params => ({ q: params.term }),
      processResults: data => ({ results: data })
    }
  });
});
</script>
{% endblock %}
