{% extends "base.html" %}
{% load crispy_forms_tags %}
{% block title %}Edit Work Order{% endblock %}
{% block content %}
<div class="container">
  <h2 class="mb-4">
    Edit Work Order #{{ job.id }}
  </h2>
  
  <!-- Navigation Buttons -->
  <div class="mb-4 text-center">
    <a href="{% url 'pending_jobs' %}" class="btn btn-outline-primary me-2">Pending Jobs</a>
    <a href="{% url 'scheduled_jobs' %}" class="btn btn-outline-primary me-2">Scheduled Jobs</a>
    <a href="{% url 'completed_jobs' %}" class="btn btn-outline-primary me-2">Completed Jobs</a>
    <a href="{% url 'workorder_create' %}" class="btn btn-outline-primary">New Work Order</a>
  </div>
  
  <form method="post">
    {% csrf_token %}
    <div class="mb-4">
      {{ form|crispy }}
    </div>
    
    <!-- Inline formset for addresses -->
    <h4>Pickup and Dropoff Addresses</h4>
    <div id="address-formset">
      {{ address_formset.management_form }}
      {% for form in address_formset %}
        <div class="card mb-3">
          <div class="card-body">
            {{ form|crispy }}
            {% if form.instance.pk %}
              <div class="form-check">
                {{ form.DELETE }} <label class="form-check-label">Delete</label>
              </div>
            {% endif %}
          </div>
        </div>
      {% endfor %}
    </div>
    
    <button type="submit" class="btn btn-success">Update Work Order</button>
    
    <!-- Create Invoice Button for Completed Work Orders -->
    {% if job.status == "completed" %}
    <button type="button" class="btn btn-primary ms-2" onclick="createInvoice({{ job.id }})">Create Invoice</button>
    {% endif %}
  </form>
  
  <div class="mt-4 d-flex justify-content-between">
    <div>
      <a href="{% url 'workorder_list' %}" class="btn btn-secondary">Back to Work Orders</a>
      <a href="{% url 'home' %}" class="btn btn-secondary">Back to Dashboard</a>
    </div>
    {% if job %}
      <div>
        <a href="{% url 'workorder_delete' job.id %}" class="btn btn-danger">Delete Work Order</a>
      </div>
    {% endif %}
  </div>
</div>

{% block extra_js %}
<script>
function createInvoice(jobId) {
  var review = confirm("Would you like to review and edit the details of this job before creating an invoice?");
  if (review) {
    // Already on the edit page, so simply alert the user to review the details
    alert("Please review and update the details, then use the Create Invoice button on the Work Order Detail page.");
  } else {
    window.location.href = "/invoices/create/?work_order=" + jobId;
  }
}
</script>
{% endblock %}
{% endblock %}
