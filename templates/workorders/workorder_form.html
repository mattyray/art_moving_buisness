{% extends "base.html" %}
{% load crispy_forms_tags %}
{% block title %}Edit Work Order{% endblock %}

{% block content %}
<div class="container">

  <!-- Navigation Buttons -->
  <div class="mb-4 text-center">
    <a href="{% url 'pending_jobs' %}" class="btn btn-outline-primary me-2">Pending Jobs</a>
    <a href="{% url 'scheduled_jobs' %}" class="btn btn-outline-primary me-2">Scheduled Jobs</a>
    <a href="{% url 'completed_jobs' %}" class="btn btn-outline-primary me-2">Completed Jobs</a>
    <a href="{% url 'workorder_create' %}" class="btn btn-outline-primary">New Work Order</a>
  </div>

  <!-- Work Order Form -->
  <form method="post" enctype="multipart/form-data">
    {% csrf_token %}

    <!-- Client and Job Info -->
    <div class="mb-4">
      <label for="{{ form.client.id_for_label }}" class="form-label fw-bold">Client</label>
      {{ form.client }}
      {% if form.client.errors %}
        <div class="text-danger">{{ form.client.errors }}</div>
      {% endif %}
      <a href="{% url 'client_create' %}" class="btn btn-sm btn-outline-primary mt-2" target="_blank">
        + Add New Client
      </a>
    </div>

    <div class="mb-4">
      {{ form.job_description|as_crispy_field }}

      <label for="{{ form.estimated_cost.id_for_label }}" class="form-label fw-bold">Estimated Cost</label>
      <div class="input-group mb-3">
        <span class="input-group-text">$</span>
        {{ form.estimated_cost }}
      </div>
      {% if form.estimated_cost.errors %}
        <div class="text-danger">{{ form.estimated_cost.errors }}</div>
      {% endif %}
    </div>

    <!-- Event Formset Section -->
    <h4>Scheduled Events</h4>
    <div id="event-formset">
      {{ event_formset.management_form }}
      {% for subform in event_formset %}
        <div class="card mb-3 event-form">
          <div class="card-body">
            {{ subform|crispy }}
            <button type="button" class="btn btn-sm btn-outline-danger remove-event mt-2">Remove</button>
          </div>
        </div>
      {% endfor %}
    </div>

    <!-- Add Event Button -->
    <div class="text-center mb-4">
      <button type="button" id="add-event" class="btn btn-outline-primary">+ Add Event</button>
    </div>

    <!-- Attachments -->
    <h4>Attachments</h4>
    <div class="card shadow-sm mb-4">
      <div class="card-body">
        <ul class="list-group">
          {% for attachment in attachments %}
            <li class="list-group-item">
              <a href="{{ attachment.file.url }}">{{ attachment.file.url }}</a>
              <small class="text-muted">(Uploaded: {{ attachment.uploaded_at|date:"Y-m-d H:i" }})</small>
            </li>
          {% empty %}
            <li class="list-group-item">No attachments.</li>
          {% endfor %}
        </ul>
        <div class="mt-3">
          {{ attachment_form|crispy }}
        </div>
      </div>
    </div>

    <!-- Notes -->
    <h4>Notes</h4>
    <div class="card shadow-sm mb-4">
      <div class="card-body">
        <ul class="list-group">
          {% for note in notes %}
            <li class="list-group-item">
              {{ note.note }}
              <small class="text-muted">({{ note.created_at|date:"Y-m-d H:i" }})</small>
            </li>
          {% empty %}
            <li class="list-group-item">No notes.</li>
          {% endfor %}
        </ul>
        <div class="mt-3">
          {{ note_form|crispy }}
        </div>
      </div>
    </div>

    <!-- Submit Buttons -->
    <div class="d-flex">
      <button type="submit" name="update_only" class="btn btn-success">Create / Update</button>
      <button type="submit" name="create_invoice" class="btn btn-danger ms-2">Update and Create Invoice</button>
    </div>
  </form>

  <!-- Navigation Footer -->
  <div class="mt-4 d-flex justify-content-between">
    <div>
      <a href="{% url 'workorder_list' %}" class="btn btn-secondary">Back to Work Orders</a>
      <a href="{% url 'home' %}" class="btn btn-secondary">Back to Dashboard</a>
    </div>
    {% if job %}
      <div>
        <a href="{% url 'workorder_delete' job.id %}" class="btn btn-danger">Delete Work Order</a>
      </div>
    {% endif %}
  </div>
</div>

<!-- Hidden empty form template -->
<template id="empty-form-template">
  <div class="card mb-3 event-form">
    <div class="card-body">
      {{ event_formset.empty_form.as_p }}
      <button type="button" class="btn btn-sm btn-outline-danger remove-event mt-2">Remove</button>
    </div>
  </div>
</template>
{% endblock %}

{% block extra_js %}
<!-- Select2 and Flatpickr -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<script>
$(function() {
  $('.select2').select2({ width: '100%', placeholder: 'Search or select a client', allowClear: true });
  flatpickr('.datepicker', { dateFormat: 'Y-m-d' });

  const formset = $('#event-formset');
  const totalForms = formset.find('input[name$="-TOTAL_FORMS"]');
  const emptyTpl = $('#empty-form-template').html();

  function attachRemove(btn) {
    btn.click(function() {
      const card = $(this).closest('.event-form');
      const delInput = card.find('input[type="checkbox"][name$="-DELETE"]');
      if (delInput.length) {
        delInput.prop('checked', true);
        card.hide();
      } else {
        card.remove();
        updateCount(-1);
      }
    });
  }

  function updateCount(delta) {
    const count = parseInt(totalForms.val(), 10) + delta;
    totalForms.val(count);
  }

  // initial remove buttons
  formset.find('.remove-event').each(function() {
    attachRemove($(this));
  });

  $('#add-event').click(function() {
    const idx = parseInt(totalForms.val(), 10);
    let newHtml = emptyTpl.replace(/__prefix__/g, idx);
    formset.append(newHtml);
    updateCount(1);
    flatpickr(formset.find(`.event-form`).last().find('.datepicker'), { dateFormat: 'Y-m-d' });
    attachRemove(formset.find('.event-form').last().find('.remove-event'));
  });
});
</script>
{% endblock %}
