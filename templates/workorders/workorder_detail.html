{% extends "base.html" %}
{% load crispy_forms_tags %}
{% block title %}Work Order Detail{% endblock %}

{% block content %}
<div class="container">
  <!-- Work Order Information Card -->
  <div class="card shadow-sm mb-4">
    <div class="card-header d-flex justify-content-between align-items-center" style="background-color: #00bcd4; color: white;">
      <h2>Work Order #{{ job.id }} Details</h2>
      <div>
        <a href="{% url 'workorder_edit' job.id %}" class="btn btn-warning btn-sm me-2">Edit Work Order</a>
        <a href="{% url 'workorder_list' %}" class="btn btn-secondary btn-sm">Back to Work Orders</a>
      </div>
    </div>
    <div class="card-body">
      <h4>Work Order Information</h4>
      <p><strong>ID:</strong> {{ job.id }}</p>
      <p><strong>Description:</strong> {{ job.job_description }}</p>
      <p><strong>Status:</strong> {{ job.get_status_display }}</p>
      <p><strong>Estimated Cost:</strong> ${{ job.estimated_cost }}</p>
      <p><strong>Created At:</strong> {{ job.created_at|date:"m/d/y g:i A" }}</p>
      <p><strong>Last Edited:</strong> {{ job.updated_at|date:"m/d/y g:i A" }}</p>
      <p><strong>Completed At:</strong>
        {% if job.completed_at %}
          {{ job.completed_at|date:"m/d/y g:i A" }}
        {% else %}
          Not Completed
        {% endif %}
      </p>
    </div>
  </div>

  <!-- Scheduled Events Card -->
  <div class="card shadow-sm mb-4">
    <div class="card-header" style="background-color: #4a90e2; color: white;">
      <h3>Scheduled Events</h3>
    </div>
    <div class="card-body">
      {% if job.events.all %}
        <ul class="list-group">
          {% for evt in job.events.all %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <div>
                <strong>{{ evt.get_event_type_display }}</strong> â€” {{ evt.address }}
                {% if evt.date %}
                  on {{ evt.date|date:"m/d/y" }}
                {% else %}
                  <em>(No date set)</em>
                {% endif %}
              </div>
              <span class="badge 
                {% if evt.event_type == 'pickup' %}bg-primary
                {% elif evt.event_type == 'pickup_wrap' %}bg-info
                {% elif evt.event_type == 'wrap' %}bg-secondary
                {% elif evt.event_type == 'install' %}bg-success
                {% elif evt.event_type == 'deliver_install' %}bg-warning text-dark
                {% elif evt.event_type == 'dropoff' %}bg-dark
                {% endif %}">
                {{ evt.get_event_type_display }}
              </span>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p>No scheduled events for this work order.</p>
      {% endif %}
    </div>
  </div>

  <!-- Create Invoice Button for Completed Work Orders -->
  {% if job.status == "completed" %}
    <div class="mb-4">
      <button type="button" class="btn btn-danger"
              onclick="window.location.href='{% url 'invoice_create' %}?work_order={{ job.id }}'">
        Create Invoice
      </button>
    </div>
  {% endif %}

  <!-- Client Information Card -->
  <div class="card shadow-sm mb-4">
    <div class="card-header" style="background-color: #03a9f4; color: white;">
      <h3>Client Information</h3>
    </div>
    <div class="card-body">
      <p><strong>Name:</strong> {{ job.client.name }}</p>
      <p><strong>Email:</strong> {{ job.client.email }}</p>
      <p><strong>Phone:</strong> {{ job.client.phone }}</p>
      <p><strong>Address:</strong> {{ job.client.address }}</p>
    </div>
  </div>

  <!-- Attachments Card -->
  <div class="card shadow-sm mb-4">
    <div class="card-header" style="background-color: #388e3c; color: white;">
      <h3>Attachments</h3>
    </div>
    <div class="card-body">
      <ul class="list-group">
        {% for attachment in attachments %}
          <li class="list-group-item">
            {% if attachment.file %}
              <a href="{{ attachment.file.url }}">{{ attachment.file.name }}</a>
            {% else %}
              <span>No file available.</span>
            {% endif %}
            <small class="text-muted">(Uploaded: {{ attachment.uploaded_at|date:"m/d/y g:i A" }})</small>
          </li>
        {% empty %}
          <li class="list-group-item">No attachments.</li>
        {% endfor %}
      </ul>
      <form method="post" enctype="multipart/form-data" class="mt-3">
        {% csrf_token %}
        {{ attachment_form|crispy }}
        <button type="submit" name="attachment_submit" class="btn btn-primary">Add Attachment</button>
      </form>
    </div>
  </div>

  <!-- Notes Card -->
  <div class="card shadow-sm mb-4">
    <div class="card-header" style="background-color: #8bc34a; color: white;">
      <h3>Notes</h3>
    </div>
    <div class="card-body">
      <ul class="list-group">
        {% for note in notes %}
          <li class="list-group-item">
            {{ note.note }}
            <small class="text-muted">({{ note.created_at|date:"m/d/y g:i A" }})</small>
          </li>
        {% empty %}
          <li class="list-group-item">No notes.</li>
        {% endfor %}
      </ul>
      <form method="post" class="mt-3">
        {% csrf_token %}
        {{ note_form|crispy }}
        <button type="submit" name="note_submit" class="btn btn-primary">Add Note</button>
      </form>
    </div>
  </div>

  <!-- Navigation Row -->
  <div class="mt-4 d-flex justify-content-between">
    <div>
      <a href="{% url 'home' %}" class="btn btn-secondary">Back to Dashboard</a>
      <a href="{% url 'workorder_list' %}" class="btn btn-secondary">Back to Work Orders</a>
    </div>
    <div>
      <a href="{% url 'workorder_delete' job.id %}" class="btn btn-danger">Delete Work Order</a>
    </div>
  </div>
</div>
{% block extra_js %}
<!-- No extra JavaScript needed here -->
{% endblock %}
{% endblock %}
