{% extends "base.html" %}
{% block title %}Calendar – {{ month }}/{{ year }}{% endblock %}

{% block content %}
  {% now "m-d-y" as today %}
  <div class="btn-group mb-3">
    <a href="{% url 'calendar_app:month_detail' %}" class="btn btn-outline-primary">Month</a>
    <a href="{% url 'calendar_app:week_detail' today %}" class="btn btn-outline-primary">Week</a>
    <a href="{% url 'calendar_app:day_detail' today %}" class="btn btn-outline-primary">Day</a>
  </div>

  <form method="get" class="mb-3">
    <input type="text" name="q" class="form-control" placeholder="Search…" value="{{ query }}">
  </form>

  <div id="calendar"></div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", function () {
  const calendarEl = document.getElementById("calendar");
  if (!calendarEl) return console.error("Calendar element not found!");

  // Safely construct initial date
  const initialDate = new Date({{ year }}, {{ month }} - 1, 1);  // JS months are 0-indexed

  const calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: "dayGridMonth",
    initialDate: initialDate,
    height: 'auto',
    events: async function(fetchInfo, success, fail) {
      try {
        const [wo, inv] = await Promise.all([
          fetch("/workorders/calendar-data/workorders/").then(r => r.json()),
          fetch("/invoices/calendar-data/invoices/").then(r => r.json())
        ]);
        success([...wo, ...inv]);
      } catch (e) {
        console.error("Calendar fetch error:", e);
        fail(e);
      }
    },
    eventClick: info => {
      if (info.event.url) {
        window.location.href = info.event.url;
        info.jsEvent.preventDefault();
      }
    }
  });

  calendar.render();
});
</script>
{% endblock %}
